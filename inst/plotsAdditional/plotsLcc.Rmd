---
title: "`r params$docTitle`"
date: "`r format(Sys.Date())`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    fig_caption: false
params:
    docTitle: "BRICK Analysis report"
    file: "BRICK_analysis_report.csv"
    path: "C:/Users/ricardar/Documents/PIAM/brick/output/noShellEUR-lowGran_2025-07-22_09.58.50/"
    scenNames: NULL
    savePlots: TRUE
    name: ""
---

```{r setup, include=FALSE}
library(dplyr) #nolint: undesirable_function_linter.
library(ggplot2) #nolint: undesirable_function_linter.

knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = FALSE,
  warning = FALSE
)
```

```{r set variables, check existence of first file}

# Assemble the file path
filePath <- file.path(params$path, params$file)

if (length(filePath) > 1) {
  stop("plotsLcc.Rmd only runs on a single file.")
}

# Check if the file exists
if (!file.exists(filePath)) {
  message("No BRICK_analysis_report.csv file found. ",
          "BRICK_calibration_calibration.csv is normally produced during calibration runs.")
  knitr::knit_exit()
}

config <- yaml::read_yaml(file.path(params$path, "config", "config_COMPILED.yaml"))
tmpl <- config[["reportingTemplate"]]

outName <- params$name
outPath <- dirname(filePath[1])


```

```{r Read in data}
data <- utils::read.csv(filePath) %>%
  filter(typ == "Res") # Temporary
```

# Lifetime distribution estimates

## Lifetime distributions of standing stock

### Mixed estimate

```{r Plot mixture outflow of standing stock}

showAnalysisPlot("bar", data, "stockInitLtMixed", yname = "absVal", color = "hs", rprt = "vin",
            xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)

```

### Mixed estimate compared to ex-ante estimate

```{r Plot mixed initial stock leave time and ex-ante estimate}
showAnalysisPlot("twoBar", data, c("stockInitLtMixed", "stockInitLtAnte"), yname = "absVal", color = "hs",
                 remCols = c("value", "relVal"), rprt = "ttotIn",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)
```

### Mixed estimate, remaining share

```{r Plot mixed leave time of initial stock, remaining share}

showAnalysisPlot("line", data, c("stockInitLtMixedRemain", "stockWbRemain"),
                 yname = "relVal", color = "hs", linetype = "variable", rprt = "vin",
                 xlabName = "Time", ylabName = "Share of remaining floorspace", tmpl = tmpl)

```

## Lifetime estimates of new constructions

### Mixed estimate

```{r Plot mixture leave time of constructions}

showAnalysisPlot("bar", data, "conLtMixed", yname = "absVal", color = "hs", rprt = "ttotIn",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)

```

### Mixed estimate compared to ex-ante estimate

```{r Plot mixed construction leave time and ex-ante estimate}
showAnalysisPlot("twoBar", data, c("conLtMixed", "conLtAnte"), yname = "absVal", color = "hs",
                 remCols = c("value", "relVal"), rprt = "ttotIn",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)
```

### Mixed estimate, remaining share

```{r Plot mixed leave time of construction, remaining share}

showAnalysisPlot("line", data, c("conLtMixedRemain", "wbRemain"), yname = "relVal",
                 color = "hs", linetype = "variable", rprt = "ttotIn",
                 xlabName = "Time", ylabName = "Share of remaining floorspace", tmpl = tmpl)

```

## Lifetime distribution of renovations

### Mixed estimate

```{r Plot mixture leave time of renovations}

showAnalysisPlot("bar", data, "renLtMixed", yname = "absVal", color = "hs", rprt = "ttotIn",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)

showAnalysisPlot("bar", data %>% filter(vin == "1970-1979"), "renLtMixed", yname = "absVal", color = "hs", rprt = "ttotIn",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)

showAnalysisPlot("bar", data %>% filter(ttotIn == 2005), "renLtMixed", yname = "absVal", color = "hs", rprt = "vin",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)

```

### Mixed estimate compared to ex-ante estimate

```{r Plot mixed renovation leave time and ex-ante estimate}

showAnalysisPlot("twoBar", data, c("renLtMixed", "renLtAnte"), yname = "absVal", color = "hs",
                 remCols = c("value", "relVal"), rprt = "ttotIn",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)
```


### Mixed estimate, remaining share

```{r Plot mixed leave time of renovations, relative values}

showAnalysisPlot("line", data, c("renLtMixedRemain", "wbRemain"), yname = "relVal",
                 color = "hs", linetype = "variable", rprt = c("vin", "ttotIn"),
                 xlabName = "Time", ylabName = "Share of remaining floorspace", tmpl = tmpl)

```

## Verification of lifetime inequality

```{r Plot left-hand side and right-hand side of lifetime inequality}

showAnalysisPlot("twoBar", data, c("lhsLtIneq", "rhsLtIneq"), yname = "value",
                 color = "hs", rprt = "vin",
                 xlabName = "Time of removal", ylabName = "Quantity in million m2", tmpl = tmpl)
```


# Lifecycle costs (LCC)

## LCC of construction with mixed lifetimes

```{r Plot LCC of construction with mixed lifetimes}
showAnalysisPlot("bar", data, "conLccMixed",
                 xname = "hs", yname = "value", color = "costType", rprt = c("ttotIn", "typ", "loc"),
                 facets = NULL, xlabName = "Heating System", ylabName = "Costs in USD/m2", tmpl = tmpl)
```

```{r Plot LCC of construction with mixed lifetimes, scaled}
showAnalysisPlot("bar", data, "conLccMixedScaled",
                 xname = "hs", yname = "value", color = "costType", rprt = c("ttotIn", "typ", "loc"),
                 facets = NULL, xlabName = "Heating System", ylabName = "Costs in USD/m2", tmpl = tmpl)
```

## LCC of renovation with mixed lifetimes

```{r Plot LCC of renovation with mixed lifetimes}
showAnalysisPlot("bar", data, "renLccMixed",
                 xname = "hs", yname = "value", color = "costType", rprt = c("ttotIn", "typ", "loc"),
                 facets = "vin", xlabName = "Heating System", ylabName = "Costs in USD/m2", tmpl = tmpl,
                 addPoints = list(variable = "renBrickAll", yname = "value", y2labName = "Brick Share"))
```

```{r Plot LCC of renovation with mixed lifetimes, full}
showAnalysisPlot("bar", data, "renLccMixedFull",
                 xname = "hsr", yname = "value", color = "costType", rprt = c("vin", "ttotIn", "typ", "loc"),
                 facets = "hs", xlabName = "Heating System", ylabName = "Costs in USD/m2", tmpl = tmpl,
                 addPoints = list(variable = "renBrickFull", yname = "value", y2labName = "Brick Share"))
```

## LCC of renovation with mixed lifetimes, matrix charts

```{r Plot renovation LCC, mixed lt as pie matrix}
showAnalysisPlot("pieChart", data, "renLccMixedFull",
                 xname = "hs", yname = "hsr", color = "costType", rprt = c("vin", "ttotIn", "typ", "loc"),
                 facets = NULL, xlabName = "Original Heating System", ylabName = "Final heating system", tmpl = tmpl)
```

```{r Plot renovation LCC, mixed lt as heat map matrix}
showAnalysisPlot("heatMap", data, "renLccMixedFull",
                 xname = "hs", yname = "hsr", rprt = c("vin", "ttotIn", "typ", "loc"),
                 facets = NULL, xlabName = "Original Heating System", ylabName = "Final heating system", tmpl = tmpl)
```

# Levelized costs of heat (LCOH)

## LCOH of construction with mixed lifetimes

```{r Plot LCOH of construction with mixed lifetimes}
showAnalysisPlot("bar", data, "conLcohMixed",
                 xname = "hs", yname = "value", color = "costType", rprt = c("ttotIn", "typ", "loc"),
                 facets = NULL, xlabName = "Heating System", ylabName = "Costs in US Cents/kWh", tmpl = tmpl)
```

## LCOH of renovation with mixed lifetimes

```{r Plot LCOH of renovation with mixed lifetimes}
showAnalysisPlot("bar", data, "renLcohMixed",
                 xname = "hs", yname = "value", color = "costType", rprt = c("ttotIn", "typ", "loc"),
                 facets = "vin", xlabName = "Heating System", ylabName = "Costs in US Cents/kWh", tmpl = tmpl,
                 addPoints = list(variable = "renBrickAll", yname = "value", y2labName = "Brick Share"))
```

```{r Plot LCOH of renovation with mixed lifetimes by hs x hsr}
showAnalysisPlot("bar", data, "renLcohMixedFull",
                 xname = "hsr", yname = "value", color = "costType", rprt = c("vin", "ttotIn", "typ", "loc"),
                 facets = "hs", xlabName = "Heating System", ylabName = "Costs in US Cents/kWh", tmpl = tmpl,
                 addPoints = list(variable = "renBrickFull", yname = "value", y2labName = "Brick Share"))
```

## LCOH of renovation with mixed lifetimes, matrix charts

```{r Plot renovation LCOH, mixed lt as pie matrix}
showAnalysisPlot("pieChart", data, "renLcohMixedFull",
                 xname = "hs", yname = "hsr", color = "costType", rprt = c("vin", "ttotIn", "typ", "loc"),
                 facets = NULL, xlabName = "Original Heating System", ylabName = "Final heating system", tmpl = tmpl)
```
```{r Plot renovation LCOH, mixed lt as heat map}
showAnalysisPlot("heatMap", data, "renLcohMixedFull",
                 xname = "hs", yname = "hsr", rprt = c("vin", "ttotIn", "typ", "loc"),
                 facets = NULL, xlabName = "Original Heating System", ylabName = "Final heating system", tmpl = tmpl)
```

# Logit shares compared to Brick shares

## Shares of renovation with mixed lifetimes

### Aggregated across all hs

```{r Plot Logit and brick Share with mixed lifetimes, all}
showAnalysisPlot("twoBar", data, c("renLogitAllMixed", "renBrickAll"),
                 yname = "value", xname = "ttotIn", color = "hs", rprt = "vin",
                 xlabName = "Time of installation", ylabName = "Shares", tmpl = tmpl)
```

### Energy ladder 1

```{r Plot Logit and brick Share with mixed lifetimes, energy ladder 1}
showAnalysisPlot("twoBar", data, c("renLogitEl1Mixed", "renBrickEl1"),
                 yname = "value", xname = "ttotIn", color = "hs", rprt = "vin",
                 xlabName = "Time of installation", ylabName = "Shares", tmpl = tmpl)
```

### By initial heating system

```{r Plot Logit and brick Share with mixed lifetimes, by hs}
showAnalysisPlot("twoBar", data, c("renLogitMixedFull", "renBrickFull"),
                 yname = "value", xname = "hs", color = "hsr", rprt = c("vin", "ttotIn"),
                 xlabName = "Previous heating system", ylabName = "Shares", tmpl = tmpl)
```
