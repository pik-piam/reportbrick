---
title: "`r params$docTitle`"
date: "`r format(Sys.Date())`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    fig_caption: false
geometry: "a4paper,left=1cm,right=1cm,top=1cm,bottom=1cm,footnotesep=0.0cm,footskip=0.1cm"
params:
    docTitle: "BRICK calibration report"
    cal: "BRICK_calibration_report.csv"
    path: ""
    scenNames: NULL
    name: ""
    figWidth: 15 
    figHeight: 10
---

```{r setup, include=FALSE}

# nolint start: undesirable_function_linter.
library(dplyr, include.only = c("%>%", "across", "any_of", ".data", "filter", "mutate",
                                "select", "where"))
# nolint end

knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = params$figWidth,
  fig.height = params$figHeight,
  fig.pos = "H"
)
```


```{r set variables and check existence of first file}

# Assemble all file paths
filePath <- file.path(params$path, params$cal)

# Check if at least one file in the given paths exists
if (!any(file.exists(filePath))) {
  message("No BRICK_calibration_report.csv file found.\n",
          "BRICK_calibration_report.csv is normally produced during calibration runs.")
  knitr::knit_exit()
}

# Extract parameters
if (!is.null(params$scenNames)) {
  names(filePath) <- params$scenNames
}

outPath <- dirname(filePath[1])

customPlots <- params$customPlots
extendedPlots <- params$extendedPlots
```


```{r load data}

if (length(filePath) == 1) {
  data <- utils::read.csv(filePath)
  color <- "ttot"
  facets <- c("loc", "typ")
} else if (length(filePath) > 1) {
  # If more than one file path is given: Assemble all data in one data frame
  data <- data.frame()
  maxIter <- Inf
  for (scen in names(filePath)) {
    if (file.exists(filePath[[scen]])) {
      tmp <- utils::read.csv(filePath[[scen]]) %>%
        mutate(scenario = scen, .before = 1)
      maxIter <- min(max(tmp[["iteration"]]), maxIter) # Find maximum common iteration
      data <- rbind(data, tmp)
    } else {
      warning("The file", filePath[[scen]], "does not exist and was skipped.")
    }
  }
  # Filter for common iterations (TODO: maybe add a switch to suppress this)
  data <- filter(data, .data[["iteration"]] <= maxIter)
  color <- "scenario"
  facets <- "scenario"
}

# Determine whether this is sequential or hierarchical calibration
varAll <- NULL
if (all(c("renBSDevAgg", "renHSDevAgg") %in% data$variable)) {
  varAll <- c("stock", "construction", "renovationBS", "renovationHS", "flow")
} else {
  varAll <- c("stock", "construction", "renovation", "flow")
}

namingMap <- c(
  stock = "stock",
  construction = "con",
  renovation = "ren",
  renovationBS = "renBS",
  renovationHS = "renHS",
  flow = "flow"
)

```


```{r define functions}

# Helper: generate varNames for calibration plots
.getVarNames <- function(suffix, skipVars = NULL) {
  vars <- setdiff(varAll, skipVars)
  paste0(namingMap[vars], suffix)
}

# Standard procedure to write a calibration plot
.createCalibrationPlot <- function(data, varName, outPath,
                                   color = NULL, facets = c("loc", "typ"),
                                   yToZero = TRUE, keepCol = NULL,
                                   addColor = NULL, newColors = NULL,
                                   textSize = 20) {
  # Extract the data
  plData <- data %>%
    filter(.data[["variable"]] %in% varName) %>%
    select(any_of(keepCol),
           # where(~ any(!is.na(.x)) && (length(unique(.x)) > 1) || unique(.x) %in% varName))
           where(~ any(!is.na(.x)) || unique(.x) %in% varName))

  # Read color map if available and rename corresponding entries
  if (!is.null(color)) {
    if (any(is.na(plData[[color]]))) {
      plData <- replace_na(plData, stats::setNames(list("none"), color))
      addColor <- stats::setNames(c(addColor, "None"), c(names(addColor), "none"))
      newColors <- rbind(newColors, data.frame(row.names = "None", color = "black"))
    }
    colorMap <- c(unlist(readBrickSets(NULL)[[color]][["elements"]]), addColor)
    if (!is.null(colorMap)) {
      plData <- plData %>%
        mutate(across(any_of(color), ~ factor(colorMap[.x], levels = colorMap)))
    } else {
      plData <- plData %>%
        mutate(across(any_of(color), ~ factor(.x, levels = unique(.x))))
    }
    if (!color %in% colnames(plData)) color <- NULL
  }
  # Remove inexisting facets
  if (all(facets %in% colnames(plData))) {
    plData <- mutate(plData, across(any_of(facets), ~ factor(.x)))
  } else {
    facets <- NULL
  }
  # Create the plots
  plList <- mip::mipIterations(plData, returnGgplots = TRUE, xAxis = "iteration",
                               color = color, facets = facets,
                               slider = NULL, facetScales = "free")
  # Modify, save and show the plots
  purrr::walk(plList, function(pl) {
    if (isTRUE(yToZero)) pl <- pl + ggplot2::expand_limits(y = 0)
    if (!is.null(color) && !is.null(colorMap)) {
      pl <- pl + ggplot2::scale_colour_manual(values = c(mip::plotstyle(colorMap, unknown = newColors)))
    }
    pl <- pl + ggplot2::theme(text = ggplot2::element_text(size = textSize))
    print(pl)
  })
}

# Helper: run calibration plots for a given suffix
.runCalibrationPlots <- function(suffix, color, facets = c("loc", "typ"), skipVars = NULL) {
  varNames <- .getVarNames(suffix, skipVars)
  for (var in varNames) {
    .createCalibrationPlot(data, var, outPath,
                           color = color, facets = facets)
  }
}


```


## Variable Reference Table

```{r}
varReference <- read.csv(getSystemFile(file.path("plotsCalibrationReporting", "variableNames.csv"),
                                       package = "reportbrick")) %>%
  filter(.data$variable %in% data$variable)

varReference %>%
  kableExtra::kbl(
    booktabs = TRUE,
    col.names = c("Variable name", "Description")
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    latex_options = c("HOLD_position")
  ) %>%
  # kableExtra::column_spec(1:2, background = bkgndColors) %>%
  kableExtra::column_spec(1, width = "3.5cm") %>%
  kableExtra::column_spec(2, width = "15cm")
```

# Overview

## Relevant quantities plotted as facets

```{r relevant quantities as facets}
ttotFirst <- unique(data$ttot[!is.na(data$ttot)])[1]
dataRelQuant <- data %>%
  filter(is.na(.data$ttot) | .data$ttot == ttotFirst) %>%
  mutate(ttot = NA)

renHsVar <- grep("renovation$|HS$", varAll, value = TRUE)

overviewAbsolute <- c("outerObjective", "stepSize", "stockDevHs", "conDevHs", "flowDevHs",
                      paste0(namingMap[renHsVar], c("DescDirHs", "SpecCostHs", "DevAgg", "DevHs")))

overviewRelative <- c("outerObjective", "stepSize", "stockDevHsRel", "conDevHsRel", "flowDevHsRel",
                      paste0(namingMap[renHsVar], c("DescDirHs", "SpecCostHs", "DevRel", "DevHsRel")))

.createCalibrationPlot(
  dataRelQuant,
  overviewAbsolute,
  outPath,
  color = "hsr",
  facets = "variable"
)
.createCalibrationPlot(
  dataRelQuant,
  overviewRelative,
  outPath,
  color = "hsr",
  facets = "variable"
)

```


# Stock and flow quantities

## Stock and flows by heating system

```{r stock and flows by hs}

.createCalibrationPlot(data, "stockHs", outPath,
                       color = "hsr", facets = facets)

.createCalibrationPlot(data, "conHs", outPath,
                       color = "hsr", facets = facets)

.createCalibrationPlot(data, "renHs", outPath,
                       color = "hsr", facets = facets)

.createCalibrationPlot(data, "flowHs", outPath,
                       color = "hsr", facets = facets)

```

## Stock and flows by vintage

```{r stock and flows by vin}

.runCalibrationPlots("Vin", color = "vin", facets = facets, skipVars = c("construction", "flow"))

```


# Absolute stock and flow deviations

## Total absolute stock and flow deviations

```{r Total absolute stock and flow deviations}

.runCalibrationPlots("DevAgg", color)


```

## Absolute deviations by heating system

```{r absolute stock and flow deviations by hs}

.runCalibrationPlots("DevHs", color = "hsr", facets = facets, skipVars = "renovationBS")

```

## Absolute deviations by vintage

```{r absolute stock and flow deviations by vin}

.runCalibrationPlots("DevVin", color = "vin", facets = facets, skipVars = c("construction", "flow"))

```


# Relative stock and flow deviations

## Total relative stock and flow deviations

```{r total relative stock and flow deviations}

.runCalibrationPlots("DevRel", color)

```

## Relative deviations by heating system

```{r relative stock and flow deviation by hs}

.runCalibrationPlots("DevHsRel", color = "hsr", facets = facets, skipVars = "renovationBS")

```

## Deviation share by heating system

```{r relative stock and flow deviation by hs, alternative 2}

.runCalibrationPlots("DevHsShare", color = "hsr", facets = facets, skipVars = "renovationBS")

```

## Relative deviations by vintage

```{r relative stock and flow deviation by vin}

.runCalibrationPlots("DevVinRel", color = "vin", facets = facets, skipVars = c("construction", "flow"))

```


# Deviations of aggregate quantities

## Total quantities

```{r aggregate stock and flow deviations}

.runCalibrationPlots("TotDev", color = color, facets = facets, skipVars = "flow")

```

## Quantities by heating system

```{r agg stock and flow deviations by hs}

.runCalibrationPlots("TotHsDev", color = "hsr", facets = facets, skipVars = c("renovationBS", "flow"))

```

# Optimization quantities

## Outer objective

```{r outer objective}

.createCalibrationPlot(data, "outerObjective", outPath, color = color)

```

## Step size

```{r step size}

.createCalibrationPlot(data, "stepSize", outPath, color = color)
```

## Intangible costs by building shell

```{r intangible costs by building shell}

.runCalibrationPlots("SpecCostBs", color = "bsr", facets = facets,
                     skipVars = c("stock", "renovationHS", "flow"))

```

## Intangible costs by heating system

```{r intangible costs by heating system}

.runCalibrationPlots("SpecCostHs", color = "hsr", facets = facets, skipVars = c("stock", "renovationBS", "flow"))

```


## Descent direction by heating system

```{r descent direction by heating system}

.runCalibrationPlots("DescDirHs", color = "hsr", facets = facets, skipVars = c("stock", "renovationBS", "flow"))

.runCalibrationPlots("DescDirHsLate", color = "hsr", facets = facets, skipVars = c("stock", "renovationBS", "flow"))
```
